"use strict";(globalThis.webpackChunkbrain=globalThis.webpackChunkbrain||[]).push([[329],{8453:(e,s,n)=>{n.d(s,{R:()=>i,x:()=>c});var t=n(6540);const r={},o=t.createContext(r);function i(e){const s=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(o.Provider,{value:s},e.children)}},8808:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"*Private/NW18/SQL Server Connector Reset Issue","title":"SQL Server Connector Reset Issue","description":"Notes : 23/1/26","source":"@site/docs/*Private/NW18/SQL Server Connector Reset Issue.md","sourceDirName":"*Private/NW18","slug":"/*Private/NW18/SQL Server Connector Reset Issue","permalink":"/*Private/NW18/SQL Server Connector Reset Issue","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{}}');var r=n(4848),o=n(8453);const i={},c=void 0,a={},l=[{value:"Proposed Solution",id:"proposed-solution",level:3},{value:"Notes",id:"notes",level:3}];function d(e){const s={a:"a",br:"br",code:"code",em:"em",h3:"h3",li:"li",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Notes"})," : 23/1/26"]}),"\n",(0,r.jsxs)(s.p,{children:["A SQL Server CDC connector\u2019s offsets point to ",(0,r.jsx)(s.strong,{children:"specific LSNs in the database\u2019s transaction log / CDC mapping tables"}),". When you do:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"``"}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["you are effectively ",(0,r.jsx)(s.strong,{children:"replacing the entire database state"})," (data + log) with what is inside the backup."]}),"\n",(0,r.jsx)(s.p,{children:"This is aligned with the general CDC/restore guidance that CDC depends on the log + capture metadata, and restores change what is available.\nIt is a common symptom in offset-mismatch scenarios: the task is up, but it cannot advance because the stored position is no longer reachable."}),"\n",(0,r.jsxs)(s.p,{children:["CDC will effectively capture changes that occur ",(0,r.jsx)(s.strong,{children:"from the restored database\u2019s current log position forward"}),". From the connector\u2019s perspective, this is a \u201cnew reality\u201d: offsets from the pre-restore world do not apply."]}),"\n",(0,r.jsx)(s.p,{children:"Summary:"}),"\n",(0,r.jsxs)(s.p,{children:["Restore changes the ",(0,r.jsx)(s.strong,{children:"database incarnation"})," and resets the ",(0,r.jsx)(s.strong,{children:"transaction log context"}),". CDC depends on LSNs being monotonic and continuous."]}),"\n",(0,r.jsx)(s.p,{children:"After a restore:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"The database has a new log timeline"}),"\n",(0,r.jsx)(s.li,{children:"Pre-restore LSNs are invalid"}),"\n",(0,r.jsx)(s.li,{children:"CDC must start tracking from the new log chain"}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Only subsequent writes after restore"})," should generate CDC events"]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["This is therefore a ",(0,r.jsx)(s.strong,{children:"log continuity"})," problem."]}),"\n",(0,r.jsx)(s.h3,{id:"proposed-solution",children:"Proposed Solution"}),"\n",(0,r.jsx)(s.p,{children:"I have shared a postman collection with appropriate labels ( mentioned in the steps below )"}),"\n",(0,r.jsxs)(s.p,{children:["Step 1: Pause the CDC connector",(0,r.jsx)(s.br,{}),"\n","Pause the SQL Server CDC connector (or stop the Connect task) so it does not retry using stale offsets."]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"List connectors : Use step_1.1-list_connectors"}),"\n",(0,r.jsx)(s.li,{children:"Check status of SQL Server connector : Use step_1.2-connector_status"}),"\n",(0,r.jsx)(s.li,{children:"Pause SQL Server connector : Use step_1.3-pause_connector"}),"\n",(0,r.jsx)(s.li,{children:"Wait for connector to pause. To confirm, use step_1.2-connector_status"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Step 2: Restore the database as done today"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Note: If CDC configuration must be preserved, restore with ",(0,r.jsx)(s.code,{children:"KEEP_CDC"})," (only if supported by the restore strategy). I suggest the team to refer to Microsoft documentation on CDC and restore behavior  ",(0,r.jsx)(s.a,{href:"https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/change-data-capture-and-other-sql-server-features?view=sql-server-ver17&utm_source=chatgpt.com",children:"https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/change-data-capture-and-other-sql-server-features?view=sql-server-ver17"})]}),"\n",(0,r.jsxs)(s.li,{children:["If ",(0,r.jsx)(s.code,{children:"KEEP_CDC"})," is not used, CDC may need to be re-enabled and jobs recreated \u2014 your Step 3 covers this."]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Step 3: Verify CDC is usable post-restore"}),"\n",(0,r.jsx)(s.p,{children:"Run the following checks on the restored database:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Database-level CDC"}),"\n",(0,r.jsx)(s.code,{children:"SELECT name, is_cdc_enabled FROM sys.databases WHERE name = 'FINWIZFINAL';"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Table-level CDC"}),"\n",(0,r.jsx)(s.code,{children:"SELECT name, is_tracked_by_cdc FROM sys.tables WHERE name IN ('<table1>', '<table2>');"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"CDC capture job (if using SQL Agent)"}),"\n",(0,r.jsx)(s.code,{children:"EXEC sys.sp_cdc_help_jobs;"})]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["If any of these checks fail, CDC must be re-enabled before proceeding.",(0,r.jsx)(s.br,{}),"\n","The ",(0,r.jsx)(s.code,{children:"KEEP_CDC"})," flag in Step 2 should help avoid this."]}),"\n",(0,r.jsxs)(s.p,{children:["Step 4: Reset connector offsets\nThis forces the connector to restart from the ",(0,r.jsx)(s.strong,{children:"post-restore CDC minimum LSN"}),". It starts from the minimum ",(0,r.jsx)(s.em,{children:"valid"})," LSN after restore"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Initiate offset delete : step_4.2-delete_offsets"}),"\n",(0,r.jsx)(s.li,{children:"Confirm offsets are deleted : step_4.3-offsets_delete_status"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Step 5: Resume or restart the connector"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Use step_5-resume_connector"}),"\n",(0,r.jsx)(s.li,{children:"Wait for connector to start. To confirm, use step_1.2-connector_status"}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"notes",children:"Notes"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Duplicates around the restore boundary are expected"}),"\n",(0,r.jsx)(s.li,{children:"Per discussion with the team, downstream dedup or upsert logic is already in place (primary key, natural key, or idempotent sink)"}),"\n",(0,r.jsxs)(s.li,{children:["If no writes occur between ",(0,r.jsx)(s.strong,{children:"Step 1 and Step 5"}),", there is ",(0,r.jsx)(s.strong,{children:"no data loss"})]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Attached are postman collection to help with Connect related actions ( Pause Connector, Reset Offset, Confirm Offset reset, Resume Connector + misc  )"})]})}function h(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);